
CXX := @CXX@
INSTALL := @INSTALL@

CXXFLAGS := @CXXFLAGS@
CPPFLAGS := @CPPFLAGS@

INTROSPECTION_OBJS := obj/introspection_table.o obj/introspection.o	\
obj/introspection_column.o obj/introspection_column_type.o

EXCEPTION_OBJS := obj/exception_not_found.o obj/exception_unsupported.o	\
obj/exception_syntax.o

DATABASE_OBJS := obj/database.o obj/database_result_set.o obj/database_parameter.o

TRANSFORM_OBJS := obj/transform_common.o obj/transform_yacc.o			\
obj/transform_lex_wrapper.o obj/transform_printable.o obj/transform_select.o	\
obj/transform_identity.o obj/transform_text.o obj/transform_create_table.o		\
obj/transform_insert.o obj/transform_auto_increment.o obj/transform_create_index.o	\
obj/transform_drop_table.o obj/transform_date_function.o obj/transform_interval.o	\
obj/transform_query.o obj/transform_print_package.o obj/transform_chain.o		\
obj/transform_comparison.o obj/transform_attribute.o obj/transform_cast.o		\
obj/transform_identity_catalyst.o obj/transform_update.o

SHIELD_OBJS := obj/shield.o $(TRANSFORM_OBJS) $(INTROSPECTION_OBJS)	\
$(DATABASE_OBJS) obj/util.o $(EXCEPTION_OBJS)

TRANSFORM_LEX_TEST_OBJS := obj/transform_lex_test.o 

INTROSPECTION_TEST_OBJS := obj/introspection_test.o	\
$(INTROSPECTION_OBJS) $(DATABASE_OBJS) obj/util.o $(EXCEPTION_OBJS)

DATABASE_TEST_OBJS := obj/database_test.o $(DATABASE_OBJS) obj/util.o	\
$(EXCEPTION_OBJS)

LDFLAGS := @LDFLAGS@ -ll -locci -lclntsh -lpthread

PROGRAMS := shield transform_lex_test shield_make_package_string

OBJ := obj
SRC := src

$(OBJ)/%.o: $(SRC)/%.cc
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -c $(SRC)/$*.cc -o $@ 

all: shield

shield: $(SHIELD_OBJS)
	$(CXX) $(SHIELD_OBJS) -o $@ $(LDFLAGS)

shield_make_package_string: src/shield_make_package_string.cc
	$(CXX) src/shield_make_package_string.cc -o $@

transform_lex_test: $(TRANSFORM_LEX_TEST_OBJS)
	$(CXX) $(TRANSFORM_LEX_TEST_OBJS) -o $@ $(LDFLAGS)

introspection_test: $(INTROSPECTION_TEST_OBJS)
	$(CXX) $(INTROSPECTION_TEST_OBJS) -o $@ $(LDFLAGS)

database_test: $(DATABASE_TEST_OBJS)
	$(CXX) $(DATABASE_TEST_OBJS) -o $@ $(LDFLAGS)

src/transform_lex.cc: src/transform_lex.y
	flex -i -osrc/transform_lex.cc src/transform_lex.y 

src/transform_yacc.cc: src/transform_yacc.y
	bison -d src/transform_yacc.y -o src/transform_yacc.cc 

src/transform_yacc.hh: src/transform_yacc.cc

src/transform_print_package.cc: shield_make_package_string shield_package.sql
	echo "#include \"transform.hh\"" >$@.tmp
	echo "void shield::transform::print_package ()" >>$@.tmp
	echo "{" >>$@.tmp
	echo -n "	cout << " >>$@.tmp
	./shield_make_package_string < shield_package.sql >>$@.tmp
	echo ";" >>$@.tmp
	echo "}" >>$@.tmp
	mv $@.tmp $@

#
# These dependencies make sure that autoconf and configure are run
# when the source code for the build configuration has changed.
#

configure: configure.ac
	./config.status --recheck

Makefile: Makefile.in configure
	./config.status


#
# Update dependencies
#
depend: src/transform_yacc.hh src/transform_lex.cc
	makedepend -fMakefile.depend -Y src/*.cc
.PHONY: depend

#
# Include automatically generated dependencies (see depend target)
#

clean:
	rm -f obj/*.o 
	rm -f src/transform_yacc.cc src/transform_yacc.hh 
	rm -f src/transform_lex.cc src/transform_lex.hh
	rm -f $(PROGRAMS)
	rm -f src/transform_print_package.cc

include Makefile.depend
